# 微信支付相关介绍

## 对称加密和非对称加密

![image-20221019212900443](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221019212900443.png)

## 非对称加密和对称加密的区别

![image-20221019213039295](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221019213039295.png)

## 摘要算法（hash）

![image-20221019220830158](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221019220830158.png)

![image-20221019214417556](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221019214417556.png)

![image-20221019215310324](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221019215310324.png)

而且就算黑客拿到了文件，并且修改了文件，但是它没有发件人的私钥，就算根据修改后的原文生成摘要，但是它没有私钥加密，所以可以判定这是否是修改过的

**数字签名主要是保证信息传输的一致性和身份认证**

## 数字证书

![image-20221019220102924](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221019220102924.png)

![image-20221019220322224](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221019220322224.png)

https协议

![image-20221019220529330](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221019220529330.png)

## 微信平台的证书

![image-20221019221432272](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221019221432272.png)

# 案例项目

![image-20221019221813391](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221019221813391.png)

## 把springboot版本切换为2.5.6

其中好多报错都是springboot版本过高引起的

配置swagger

![image-20221020104522343](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221020104522343.png)

![image-20221020104529413](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221020104529413.png)

# controller的注解配置

![image-20221020104841546](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221020104841546.png)

![image-20221020104912237](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221020104912237.png)

swagger作用是方便测试

# 项目的配置

## pom文件的配置

![image-20221020105332351](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221020105332351.png)

![image-20221020105938860](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221020105938860.png)

![image-20221020110218949](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221020110218949.png)



## application的配置

![image-20221021151330133](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221021151330133.png)

![image-20221020110459411](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221020110459411.png)

# result（返回前端的vo类



![image-20221020113309326](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221020113309326.png)



![image-20221020114128731](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221020114128731.png)

# 创建并连接数据库





![image-20221020113332041](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221020113332041.png)





# application

![image-20221020112324722](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221020112324722.png)

# mybatis-plus功能

![image-20221021155956117](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221021155956117.png)

![image-20221021160102045](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221021160102045.png)

![image-20221021161322443](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221021161322443.png)

## mybsatis-plus文件的配置

![image-20221021160400795](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221021160400795.png)

# 利用Swagger查看数据

![image-20221022100945774](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022100945774.png)

http://localhost:8090/swagger-ui.html

它里面有各种路径，不一定要启动相应的页面

# 关于mybatis-plus下xml的配置

![image-20221022101914842](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022101914842.png)

上面那个是日志，两步骤 ，第一个是pom文件中过滤资源，第二个就是这个

mapper里面的路径就是targrt:classes下的路径

![image-20221022102745236](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022102745236.png)

# 基础支付

## 引入支付参数

![image-20221022105222244](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022105222244.png)

![image-20221022105623148](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022105623148.png)

![image-20221022110620464](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022110620464.png)

## 优化

![image-20221022111209873](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022111209873.png)

![image-20221022111248169](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022111248169.png)

```
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-configuration-processor</artifactId>
    <optional>true</optional>
</dependency>
```

还要配置这个来将信息对应

## 私钥的加载

首先将私钥放入src下

![image-20221022153014104](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022153014104.png)

![image-20221022152738582](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022152738582.png)

用依赖引入

![image-20221022152802984](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022152802984.png)

在配置类里下获取私钥文件的方法

![image-20221022153736462](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022153736462.png)

![image-20221022154220470](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022154220470.png)

![image-20221022162714134](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022162714134.png)

## 获取验签器和httpclient

![image-20221022220102369](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022220102369.png)

# APLV3-API字典和相关工具

![image-20221022220702381](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022220702381.png)

![image-20221022221026733](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022221026733.png)

## 将需要的退款等等接口列为枚举

![image-20221022221452873](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221022221452873.png)

# 加入vue然后开放前端端口

![image-20221023130319296](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221023130319296.png)

因为是跨域访问，所以请求的url和数据一定要相同，不同的前端不显示

![image-20221023130440607](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221023130440607.png)

## 启动vue

![image-20221023130540747](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221023130540747.png)

![image-20221023130616031](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221023130616031.png)

![image-20221023130647483](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221023130647483.png)

然后打出npm run serve

![image-20221023130714607](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221023130714607.png)

出现这个则是已经启动

# native下单

## 链式操作注解

![image-20221023135734350](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221023135734350.png)

## 生成订单和临时创建订单对象，调用统一下单API

## 业务流程

![image-20221023141544481](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221023141544481.png)

![image-20221023141617683](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221023141617683.png)

因为他是jso你参数所以要转json

## 商户订单号和拿到二维码的url

```java
 //生成订单号订单号
        String orderNo = OrderNoUtils.getOrderNo();
        //然后创建订单对象，然后将需要的值写入
        OrderInfo orderInfo = new OrderInfo();
        orderInfo.setOrderNo(orderNo);
        orderInfo.setTitle("test");
        orderInfo.setProductId(orderid);
        orderInfo.setTotalFee(1);//分
        orderInfo.setOrderStatus(OrderStatus.NOTPAY.getType());//未支付
        //将订单存入数据库


        //下单
        //这个里面是请求的地址：微信服务器地址+url地址（native接口的地址）
        HttpPost httpPost = new HttpPost(wxPayConfig.getDomain().concat(WxApiType.NATIVE_PAY.getType()));
        // 请求body参数
        //然后new一个map进行参数的封装
        Map paramsMap = new HashMap();
        paramsMap.put("appid",wxPayConfig.getAppid());
        paramsMap.put("mchid",wxPayConfig.getMchId());
        paramsMap.put("description",orderInfo.getTitle());
        paramsMap.put("out_trade_no",orderNo);
        //通知地址，微信发给商家的，我们用外网穿透地址＋上接受地址
        paramsMap.put("notify_url", WxNotifyType.NATIVE_NOTIFY.getType().concat(wxPayConfig.getNotifyDomain()));
       //订单金额，因为要传入两个参数，所以用套入map实现
        HashMap<Object, Object> Map = new HashMap<>();
        //总金额
        Map.put("total",orderInfo.getTotalFee());
        //货币类型
        Map.put("currency","CNY");
        paramsMap.put("amount",Map);
        //然后将他们转化为json格式
        Gson gson = new Gson();
        String jsonParams = gson.toJson(paramsMap);
         log.info("请求参数"+jsonParams;

            //将参数封装进entity中
        StringEntity entity = new StringEntity(jsonParams,"utf-8");
        //因为httpclient是json格式接受所以设置一下，用hson做数据交换
        entity.setContentType("application/json");
        //将它放入httpPost中
        httpPost.setEntity(entity);
        //同样设置格式
        httpPost.setHeader("Accept", "application/json");
        //完成签名并执行请求
        //将验签的结果生辰大哥httpclent注入进来
        CloseableHttpResponse response = null;
        try {
            //将请求发送出去得到相应的对象
            //Patclient是验签器
            response = PayClient.execute(httpPost);
        } catch (IOException e) {
            e.printStackTrace();
        }
//然后对返回的结果进行验证
        try {
            String responBody = EntityUtils.toString(response.getEntity());
            int statusCode = response.getStatusLine().getStatusCode();
            if (statusCode == 200) { //处理成功
                System.out.println("成功，返回结果 = " + responBody);
            } else if (statusCode == 204) { //处理成功，无返回Body
                System.out.println("success");
            } else {
                System.out.println("native下单失败,响应码 = " + statusCode+ ",返回结果 = " + responBody);
                throw new IOException("request failed");
            }
            //如果成功了就拿到它的结果，然后进行解析
            HashMap <String,String>resultMap = gson.fromJson(responBody, HashMap.class);
            //拿到二维码连接
            String code_url = resultMap.get("code_url");
            //然后返回结果
            HashMap<String, Object> map = new HashMap<>();
            map.put("codeUrl",code_url);
            map.put("orderNo",orderInfo.getOrderNo());
            return map;

        } finally {
            response.close();
        }
        return null;
```



![image-20221023152951520](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221023152951520.png)

![image-20221023153346919](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221023153346919.png)

![image-20221023154940817](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221023154940817.png)

## 二维码的展示

它的展示需要组件，去网上搜一下。根据后端返回的url生成二维码

# bean是初始化的时候启动的

## 

用之前的



# 接受通知和返回应答

![image-20221023172709502](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221023172709502.png)

![image-20221023173648698](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221023173648698.png)

![image-20221023173918975](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221023173918975.png)

下面就是验签和处理订单了

# 签名的验证

## 请求签名（发起支付的时候）



![image-20221024144333063](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024144333063.png)

![image-20221024144438013](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024144438013.png)

这是发起支付的验签

![image-20221024145119237](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024145119237.png)

因为签名器封装了商户的私钥，所以验签器会自动生成签名从而提交到微信平台，平台会用商户的公钥进行解密验证数据的真实性

![image-20221024145824447](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024145824447.png)

## 应答签名（微信平台返回的收款二维码的url和订单号）

# 私钥签名和公钥的验签过程

![image-20221024154904930](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024154904930.png)

都是由验签器操作的

![image-20221024155046615](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024155046615.png)

# 签名生成和验签源码的分析

因为我们由sdk的自动签名生成和验签的封装，下面是工作流程

![image-20221024155842603](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024155842603.png)

## 构造签名串===然后他就在底层构造签名串

![image-20221024155922660](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024155922660.png)

## 计算签名值

![image-20221024160202802](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024160202802.png)

## 设置http头

![image-20221024204507085](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024204507085.png)

### 签名信息

![image-20221024205045123](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024205045123.png)

![image-20221024205229499](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024205229499.png)

![image-20221024205354088](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024205354088.png)

# 验签

![image-20221024210047074](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024210047074.png)

**请求的过程是建议要验证签名吗，而回调是必须验证签名**

**我们调用的SDK已经写了这些**

![image-20221024211040259](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024211040259.png)

这里自动更新验证器会证书列表会自动下载并且更新的

![image-20221024211746459](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024211746459.png)

![image-20221024211839494](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024211839494.png)

## 流程

### 构造验签名串

![image-20221024213306118](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024213306118.png)

![image-20221024213145653](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024213145653.png)

![image-20221024213221052](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024213221052.png)

### 获取应答的签名

![image-20221024213431542](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024213431542.png)

![image-20221024213657101](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024213657101.png)

### 验证签名

![image-20221024213556574](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024213556574.png)

## 详细：签名的话先生成摘要然后私钥加密，最后base64编码；验签：先base64解码，然后公钥解密

![image-20221024214411396](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024214411396.png)

# 微信给商家发送支付结果

![image-20221024214520322](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024214520322.png)

![image-20221024214836843](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024214836843.png)

## 验签与解密

![image-20221024215319611](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024215319611.png)

![image-20221024223745727](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024223745727.png)

然后将所需要的参数传入

解密后报文是json形式



![image-20221024224545723](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221024224545723.png)

详细参数见api

揭秘之后是json所以转为map就可以提取数据了

# 对解密后的密文进行处理订单

然后就更改订单的状态和金额等等

# 平台重复发通知解决这种问题

![image-20221025211111148](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221025211111148.png)

![image-20221025211319899](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221025211319899.png)

直接判断订单的状态是否已支付，已支付直接返回

## 接口调用的幂等性

![image-20221025211532717](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221025211532717.png)

## 数据锁

![image-20221025213159018](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221025213159018.png)

对数据状态检查和数据的处理之前用锁

最后final要释放锁

![image-20221025213303237](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221025213303237.png)

注意这个琐是可重入的锁

![image-20221025213345476](C:\Users\lan'ru'zhan\AppData\Roaming\Typora\typora-user-images\image-20221025213345476.png)